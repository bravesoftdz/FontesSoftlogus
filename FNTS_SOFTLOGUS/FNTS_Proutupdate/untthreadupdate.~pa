unit untthreadupdate;

interface

uses
  Classes, sysutils, IniFiles;

type
  threadupdate = class(TThread)
  private

    { Private declarations }
  protected
    procedure Execute; override;
  public
    procedure conectar();
  end;


implementation

uses untfrmproutupdate;

{ retorna a versão do executavel }

procedure threadupdate.conectar;
var
  ServerIni: TIniFile;
  passivo, arquivo, diretorio, diretorio_ftp: string;
var datestr: string;
begin
  while not terminated do
  begin
    ServerIni := TIniFile.Create(ExtractFilePath(ParamStr(0)) + 'FTPConfig.ini');
    passivo := ServerIni.ReadString('CONEXAO', 'PASSIVO', '');
    with frmproutupdate do
    begin
      ftpupdate.Host := ServerIni.ReadString('CONEXAO', 'FTP', '');
      ftpupdate.port := StrToInt(ServerIni.ReadString('CONEXAO', 'PORTA', ''));
      ftpupdate.Username := ServerIni.ReadString('CONEXAO', 'USUARIO', '');
      ftpupdate.Password := ServerIni.ReadString('CONEXAO', 'PASSWD', '');
      arquivo := ServerIni.ReadString('CONEXAO', 'ARQUIVO', '');
      diretorio := ServerIni.ReadString('CONEXAO', 'SALVAR', '');
      diretorio_ftp := ServerIni.ReadString('CONEXAO', 'DIRFTP', '');
      if passivo = 'S' then
        ftpupdate.Passive := true
      else
        ftpupdate.passive := false;
      ServerIni.Free;
      ftpupdate.Connect();
      ftpupdate.changedir(diretorio_ftp);
      ftpupdate.list(memo1.Lines);
      BytesToTransfer := ftpupdate.Size(arquivo);

      if not FileExists(diretorio + '\' + arquivo) then
      begin
        ftpupdate.get(arquivo, diretorio + '\' + arquivo, true);
        ftpupdate.Disconnect;
        frmproutupdate.AdvGlowButton1.Enabled := True;
        frmproutupdate.AdvGlowButton2.Enabled := True;
        frmproutupdate.AdvGlowButton3.Enabled := True;
        FileSetDate(diretorio + '\' + arquivo, DateTimeToFileDate(ftpupdate.DirectoryListing.Items[0].ModifiedDate));
      end
      else
      begin

        if FormatDateTime('dd/mm/yyyy HH:mm',FileDateToDateTime(FileAge('vnc.exe'))) <>
FormatDateTime('dd/mm/yyyy HH:mm',
frmproutupdate.ftpupdate.DirectoryListing.Items[0].ModifiedDate) then
        begin

          DeleteFile(Pchar(ExtractFilePath(ParamStr(0)) + arquivo + '.old'));
          RenameFile(ExtractFilePath(ParamStr(0)) + arquivo,
            ExtractFilePath(ParamStr(0)) + arquivo + '.old');
          ftpupdate.get(arquivo, diretorio + '\' + arquivo, true);
          FileSetDate(diretorio + '\' + arquivo, DateTimeToFileDate(ftpupdate.DirectoryListing.Items[0].ModifiedDate));
          ftpupdate.Disconnect;
          frmproutupdate.AdvGlowButton1.Enabled := True;
          frmproutupdate.AdvGlowButton2.Enabled := True;
          frmproutupdate.AdvGlowButton3.Enabled := True;


        end
        else
        begin
          frmproutupdate.Memo1.Visible := True;
          frmproutupdate.Memo1.Lines.Add('Voçe já possui a versão mais recente do arquivo...!');
        end;
      end;


    end;
    frmproutupdate.ftpupdate.Disconnect;
    frmproutupdate.AdvGlowButton1.Enabled := True;
    frmproutupdate.AdvGlowButton2.Enabled := True;
    frmproutupdate.AdvGlowButton3.Enabled := True;
    frmproutupdate.Gauge1.Progress := 0;
    frmproutupdate.Repaint;
    terminate;

  end;
end;

procedure threadupdate.Execute;
begin
  conectar();
end;

end.

